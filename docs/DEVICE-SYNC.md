# Device Sync — Cross-Device Playback Control

Spotify Connect-like feature for controlling playback across devices.

## Architecture

- **Sync Worker**: Cloudflare Durable Object with WebSocket Hibernation (free tier)
- **Auth**: HMAC-SHA256 tokens (24hr validity), generated by main app
- **Local Sync**: BroadcastChannel API for same-browser tab sync (zero server cost)
- **Cost**: ~0 on CF free plan (WebSocket hibernation, 20:1 message billing ratio)

## Files Created

### Sync Worker (`device-sync-worker/`)
| File | Purpose |
|---|---|
| `src/index.ts` | Durable Object + Worker entry point. WebSocket Hibernation handlers, device registry, message routing, CORS, HMAC token validation |
| `wrangler.jsonc` | Worker config with DO binding, SQLite migration, allowed origins |
| `package.json` | Worker dependencies (wrangler, @cloudflare/workers-types) |
| `tsconfig.json` | TypeScript config for CF Workers |
| `.gitignore` | Ignores node_modules/ and .wrangler/ |

### Client Library (`lib/device-sync/`)
| File | Purpose |
|---|---|
| `protocol.ts` | Shared message types (`ClientMessage`, `ServerMessage`, `DeviceInfo`, `NowPlayingInfo`, etc.), `getDeviceId()` (localStorage UUID), `detectDevice()` (UA parsing) |
| `client.ts` | WebSocket client with auto-reconnect (exponential backoff 1s→30s cap), token refresh, message routing |
| `broadcast.ts` | BroadcastChannel wrapper for cross-tab sync, self-message filtering |

### Store (`lib/stores/`)
| File | Purpose |
|---|---|
| `device-sync.ts` | Zustand store — connection management, device list, command dispatch (browser video + VLC), now-playing reporting, settings store integration |

### Components (`components/device-sync/`)
| File | Purpose |
|---|---|
| `device-picker.tsx` | Dropdown in header — shows connected devices, now-playing, inline controls, transfer buttons, "Connect a device" button |
| `remote-banner.tsx` | Fixed bottom bar when controlling remote device — seek bar, play/pause/skip/stop, device info |
| `device-sync-reporter.tsx` | Passive MutationObserver — watches for `<video>` elements, reports now-playing to sync store. Also monitors VLC via dynamic import |
| `pair-dialog.tsx` | Dialog with shareable pairing link (generates via `/api/remote/token`), copy + share buttons |

### API & Pages
| File | Purpose |
|---|---|
| `app/api/remote/token/route.ts` | GET — generates HMAC token for authenticated user (24hr expiry, 1hr cache) |
| `app/(public)/pair/page.tsx` | Public remote control page — connect via token in URL, see devices, now-playing card with full controls |

### Modified Files
| File | Changes |
|---|---|
| `lib/stores/settings.ts` | Added `deviceSync: boolean` setting with default `false` |
| `app/(auth)/(app)/settings/page.tsx` | Added Device Sync toggle in Integrations section |
| `app/(auth)/(app)/layout.tsx` | Added DevicePicker to header, RemoteControlBanner + DeviceSyncReporter to layout, `initDeviceSync()` on mount |
| `wrangler.jsonc` | Added `NEXT_PUBLIC_DEVICE_SYNC_URL` env var |
| `tsconfig.json` | Excluded `device-sync-worker` from main TS compilation |
| `eslint.config.mjs` | Added `device-sync-worker/**` to global ignores |

## Deployment

Worker deployed at: `https://debridui-sync.vanshbh7102-619.workers.dev`

### Secrets Set
- `SYNC_TOKEN_SECRET` on both `debridui-sync` worker and `debridui` main worker
- Same value: `VIexTNjfVlX68yamU1Dzk0fsjLmgeHJ4b1QG8+DGr4o=`

### Environment Variables
- `NEXT_PUBLIC_DEVICE_SYNC_URL` = `https://debridui-sync.vanshbh7102-619.workers.dev` (in wrangler.jsonc + .env.local)

## How to Test

### Test 1: Device Discovery
1. Open DebridUI in Chrome
2. Settings → Integrations → enable **Device Sync**
3. Header bar → click the **monitor icon** (device picker)
4. Should see "This device" (Desktop - Chrome)
5. Open in another browser/incognito → enable Device Sync
6. Both browsers should see each other in their device pickers

### Test 2: Remote Playback Control
1. Device A: start playing any video
2. Device B: open device picker → see what's playing on A (title, progress)
3. From B: click play/pause → should control A's video
4. Try the seek bar from B

### Test 3: Transfer Playback
1. While playing on A, go to B's device picker
2. Click transfer icon next to A → sends video URL to B

### Test 4: Pairing Link (TV/Kiosk)
1. Device picker → "Connect a device"
2. Copy the shareable link
3. Open on phone or any browser (no login needed)
4. Lightweight remote control page with now-playing + controls

### Test 5: Same-Browser Tab Sync
1. Open DebridUI in two tabs (same browser)
2. Play something in tab 1
3. Tab 2's device picker should show it playing (via BroadcastChannel, no server)

### Quick Smoke Test
1. Enable Device Sync
2. Open app in two different browsers
3. Click device picker in either → both should appear
4. If they do, WebSocket connection works ✓

## Redeploying the Sync Worker

```bash
cd device-sync-worker
npm install
npx wrangler deploy
```

To update the secret:
```bash
npx wrangler secret put SYNC_TOKEN_SECRET
# Then enter the secret value
```
